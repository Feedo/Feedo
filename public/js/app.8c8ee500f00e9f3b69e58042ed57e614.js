
var Feed=Backbone.RelationalModel.extend({relations:[{type:Backbone.HasMany,key:'items',relatedModel:'FeedItem',collectionType:'FeedItemCollection',collectionOptions:function(instance){return{instance:instance};}}],urlRoot:"/api/feeds"});var FeedCollection=Backbone.Collection.extend({model:Feed,url:'/api/feeds',comparator:function(feed){return new Date(feed.get("id")).getTime();}});var FeedItem=Backbone.RelationalModel.extend({});var FeedItemCollection=PaginatedCollection.extend({model:FeedItem,comparator:function(item){return-(new Date(item.get("published")).getTime());},initialize:function(data,options){var self=this;options.instance.bind("change",function(){self.url="/api/feeds/"+options.instance.id+"/items";});self.url="/api/feeds/"+options.instance.id+"/items";return PaginatedCollection.prototype.initialize.call(this)}})
var Feeds=new FeedCollection;var APPNAME="Feedo";var Router=Backbone.Router.extend({routes:{"":"main","feed/:id-:name":"feed"},main:function(){document.title=APPNAME;},feed:function(id,name){var self=this;Feeds.fetch().done(function(){var feed=Feeds.get(id);self.itemMenuView=new FeedItemMenuView({collection:feed.get("items")});$('#btn-next-page').remove();self.itemMenuView.render();document.title=APPNAME+" - "+feed.get("title");});}});FeedoRouter=new Router;Backbone.history.start({pushState:true});var FeedMenuView=Backbone.View.extend({tagName:"ul",el:'#feed-menu',initialize:function(){this.listenTo(this.collection,'add',this.render);this.listenTo(this.collection,'change',this.render);},render:function(){var self=this;self.collection.sort();self.$el.html("");self.collection.each(function(feed){var item=new FeedMenuItemView({model:feed});self.$el.append(item.render().el);});return self;}});var FeedMenuItemView=Backbone.View.extend({template:_.template($("#feed-menu-item-template").html()),tagName:'li',className:'feed-menu-item',events:{'click':'showFeedItems','click .btn-delete-feed':'deleteFeed',},initialize:function(){this.model.on('change',this.render,this);this.model.on('destroy',this.remove,this);},render:function(){this.$el.data('feedId',this.model.get('id'));this.$el.html(this.template(this.model.toJSON()));return this;},showFeedItems:function(){console.log(this.model.id);FeedoRouter.navigate("feed/"+this.model.id+"-"+this.model.get("title").toLowerCase(),{trigger:true});return false;},deleteFeed:function(){var feedTitle=this.model.get("title");$("#modal-delete-feed .feed-title").text(feedTitle);$("#modal-delete-feed").modal('show').data('feed-model',this.model);}});var FeedItemMenuView=Backbone.View.extend({el:$("#feed-menu-view"),initialize:function(){this.collection.on('add',this.render,this);this.collection.on('destroy',this.remove,this);this.collection.fetch();},initializePaginationButton:function(){var self=this;if(!self.nextButton&&self.$el){var nextPage=document.createElement("button");$(nextPage).addClass("btn btn-primary ladda-button");$(nextPage).attr('data-style','contract');$(nextPage).html('<span class="ladda-label">Load more...</span>');var ladda=Ladda.create(nextPage);$(nextPage).click(function(){ladda.start();self.addNextPage(function(){ladda.stop();});});var wrapper=document.createElement("div");$(wrapper).attr('id','btn-next-page');$(wrapper).css('text-align','center');$(wrapper).append(nextPage);self.nextButton=wrapper;}
if($('#btn-next-page').length==0){self.$el.after(self.nextButton);}
if(self.collection.length<(self.collection.page*self.collection.perPage)){$(self.nextButton).fadeOut();}else{$(self.nextButton).fadeIn();}},render:function(){var self=this;self.collection.sort();self.$el.html("");self.collection.each(function(item){var itemView=new FeedItemMenuItemView({model:item});self.$el.append(itemView.render().el);});self.initializePaginationButton();self.$el.data('view',self);return this;},addNextPage:function(success){var self=this;self.collection.addNextPage(function(newCollection){success&&success(newCollection);var newLength=newCollection.length;if(newLength<(newCollection.page*newCollection.perPage)){$(self.nextButton).hide();}});}});var FeedItemMenuItemView=Backbone.View.extend({template:_.template($("#feed-item-menu-item-template").html()),tagName:'li',className:"feed-item-menu-item",events:{'click':'handleClick'},initialize:function(){this.model.on("change",this.render,this);this.model.on("destroy",this.remove,this);},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.find('.feed-content').hide();if(!this.model.get("read")){this.$el.addClass("unread");}else{this.$el.removeClass("unread");}
return this;},handleClick:function(e){var $el=$(e.target);if(!$el.data('external-link')){return this.toggleVisibility();}},toggleVisibility:function(){if(!this.model.get("read")){this.model.set("read",true).save({},{success:function(){Feeds.fetch();}});}
if(!this.$el.hasClass("open")){if(!this.$el.find('.feed-content').text()){var content=(this.model.get("content"))?this.model.get("content"):this.model.get("summary");this.$el.find('.feed-content').html(content);this.$el.find('.feed-content a').attr('target','_blank').data('external-link',true);if(!this.$el.find('.feed-content img').attr('alt')){this.$el.find('.feed-content img').attr('alt','Image');}}
this.$el.addClass("open");this.$el.find('.feed-abstract').fadeOut('fast');this.$el.find('.feed-content').fadeIn();}else{this.$el.removeClass("open");this.$el.find('.feed-abstract').fadeIn();this.$el.find('.feed-content').fadeOut('fast',function(){$(this).html('');});}
this.$el.smoothScrollTop();return false;}});var AppView=Backbone.View.extend({el:$("#feedoapp"),initialize:function(){var FeedMenu=new FeedMenuView({collection:Feeds});Feeds.fetch();},updateAndRefresh:function(){var self=this;$("#btn-refresh .icon-refresh").addClass("rotating");$.get("/api/update_feeds",function(responseData){self.refresh();$("#btn-refresh .icon-refresh.rotating").removeClass("rotating");});},refresh:function(){Feeds.fetch();},events:{"keyup #modal-add-feed #input-add-feed":"checkAddFeedInput","keydown #modal-add-feed #input-add-feed":"checkAddFeedInput","click #modal-add-feed .btn-primary":"addFeed","click #btn-refresh":"updateAndRefresh",'click #modal-delete-feed .btn-delete':'deleteFeedConfirmed'},checkAddFeedInput:function(){var url=$("#input-add-feed").val();if(url){$("#modal-add-feed .btn-primary").removeAttr('disabled');}else{$("#modal-add-feed .btn-primary").attr('disabled','disabled');}},addFeed:function(){var self=this;var url=$("#input-add-feed").val();if(url){var feed=new Feed({file_url:url});$("#modal-add-feed input, #modal-add-feed .btn").attr('disabled','disabled');feed.save({},{success:function(model,response,options){$("#modal-add-feed").modal('hide');$("#input-add-feed").val("");$("#modal-add-feed input, #modal-add-feed .btn").removeAttr('disabled');self.refresh();},error:function(model,xhr,options){alert(xhr.responseJSON.message);$("#modal-add-feed input, #modal-add-feed .btn").removeAttr('disabled');}});}
return false;},deleteFeedConfirmed:function(){var model=$("#modal-delete-feed").data('feed-model');model.destroy({success:function(){$("#modal-delete-feed").modal('hide');},error:function(){alert("An error occured. The feed may not be deleted.");}})
return false;}});var WindowView=Backbone.View.extend({el:$(window),events:{'scroll':'onScroll'},initialize:function(){var App=new AppView;},onScroll:function(){var offsetFromBottom=$(document).height()-(this.$el.scrollTop()+this.$el.height());if(offsetFromBottom<100){var feedMenuView=$("#feed-menu-view").data('view');if(feedMenuView){if($(feedMenuView.nextButton).css('display')!='none'){feedMenuView.addNextPage();}}}}});var Window=new WindowView;